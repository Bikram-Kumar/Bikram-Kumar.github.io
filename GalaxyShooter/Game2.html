<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale = 1, user-scalable = no">
  <title> Galaxy Shooter </title>
  <style>
    body {
      overflow: hidden;
      margin: 0;
      -moz-user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
    }
    html {
      overflow: hidden;
    }
    #cnvs {
      /* background-color: ;*/
      background-color: transparent;
    }
    #gameArea {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #01062c;
    }
    #canvasArea {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #scoreHead {
      color: white;
      position: absolute;
      top: 5px;
    }
    #buttonsDiv {
      position: absolute;
      bottom: 10vh;
      width: 100%;
    }
    #controlButtons {
      position: absolute;
      left: 5vw;
      bottom: -5vh;
      transform: scale(1);
    }
    #shootingButtons {
      position: absolute;
      right: 5vw;
      bottom: 5vh;
    }
    /*button[data-direction="up"] {
    }*/
    button[data-direction="left"] {
      transform: rotate(-90deg);
    }
    button[data-direction="right"] {
      transform: rotate(90deg);
    }
    button[data-direction="down"] {
      transform: rotate(180deg);
    }
    #controlButtons > :not(button[data-direction="left"]) {
      position: relative;
      left: 47px;
    }

    /* #scoreHead > span:nth-child(1) {
      position: absolute;
      left: 10px;
    }
    #scoreHead > span:nth-child(2) {
      position: absolute;
      right: 10px;
    }*/


  </style>
</head>
<body>
  <div id="gameArea">
    <div id="canvasArea">
      <div id="scoreHead">
        <span>Score: 0</span> <span>HI Score: 10890</span>
      </div>
      <canvas id="cnvs" width="480" height="320"></canvas>
      <div id="buttonsDiv">
        <div id="controlButtons">
          <button data-direction="up" ontouchstart="move(1, false)" ontouchend="move(1, true)">
            <svg width=32 height=16>
              <polygon points="16,2 8,16 24,16 "
                />
            </svg>
          </button>
          <br>
          <br>

          <button data-direction="left" ontouchstart="move(4, false)" ontouchend="move(4, true)">
            <svg width=32 height=16>
              <polygon points="16,2 8,16 24,16 "
                />
            </svg>
          </button>
          <button data-direction="right" ontouchstart="move(2, false)" ontouchend="move(2, true)">
            <svg width=32 height=16>
              <polygon points="16,2 8,16 24,16 "
                />
            </svg>
          </button>
          <br>
          <br>
          <button data-direction="down" ontouchstart="move(3, false)" ontouchend="move(3, true)">
            <svg width=32 height=16>
              <polygon points="16,2 8,16 24,16 "
                />
            </svg>
          </button>
        </div>
        <div id="shootingButtons">
          <button ontouchstart="shoot(false)" ontouchend="shoot(true)">Shoot
          </button>
          <button onclick="ultra()">Ultra
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>

    //Variables First!!
    var cnvs = document.getElementById("cnvs");
    var gameArea = document.getElementById("gameArea");
    var scoreDisplay = document.querySelector("#scoreHead > span");
    var score = 0;
    var controlMode = 2;
    var ctx = cnvs.getContext("2d");
    var animationBucket = [];
    var intervalControls = [];
    var audioContext = new (window.AudioContext || window.webkitAudioContext) ();
    createArrayBuffer('bulletSound.wav', 'bulletSound');
    //EventListeners Are Here!

    window.ondblclick = function (e) {
      e.preventDefault();
      gameArea.requestFullscreen();
      
    }
 
    
    window.onresize = window.onorientationchange = function() {
      fitCanvasToScreen();
    }
    window.onload = function () {
    //  controlMode = prompt("Choose control: 1.Touch Screen OR 2.Buttons", 2);
      fitCanvasToScreen();

      setInterval(sendEnemies, 800);
      bulletImage = ImageObject(imageFolder + "bullet.png");
      ufoImage = ImageObject(imageFolder + "ufo.png");
      whiteShipImage = ImageObject(imageFolder + "whiteShip.png");

      setTimeout(startGame, 500);
      if (controlMode == 1) {
        deployTouchScreenMode();
      }
    }
    function deployTouchScreenMode() {
      gameArea.addEventListener("touchstart", handleTouchStart);

      gameArea.ontouchend = cnvs.ontouchcancel = function() {
        clearInterval(callerOfCNVSTouchStart);
        gameArea.addEventListener("touchstart", handleTouchStart);
        shoot(true);
      }

      gameArea.ontouchmove = function (e) {
        e.preventDefault()

      }
    }
    function handleTouchStart(event) {
      event.preventDefault();
      gameArea.removeEventListener("touchstart", handleTouchStart);
      var x1 = event.touches[0].clientX-cnvs.offsetLeft;
      callerOfCNVSTouchStart = setInterval(function () {
        if (x1 > cnvs.width/2 && whiteShip.x2 < cnvs.width/scaleFactor) {
          whiteShip.x1 += 3;
        } else if (x1 < cnvs.width/2 && whiteShip.x1 > 0) {
          whiteShip.x1 -= 3;
        }
      },
        20);
    shoot(false);
    }
    


    // Functions Go Here!




    function startGame() {
      ctx.beginPath();
      ctx.clearRect(0, 0, cnvs.width, cnvs.height);
      handleDrawingObjects();
      detectCollisions();

      callerOfAnimationStarter = requestAnimationFrame(startGame);
    }

    function updateScore() {
      scoreDisplay.innerHTML = "Score: " + score;
    }

    function handleDrawingObjects() {
      animationBucket.forEach(function (item) {
        if (item.y2 > 0 && item.y1 < cnvs.height/scaleFactor) {
          decideMovements(item);
          item.draw();
        } else {
          var itsIndex = animationBucket.indexOf(item);
          animationBucket.splice(itsIndex, 1);
        }
      }
      );
    }
    function shoot(isStarted) {
      if (!isStarted) {
        makeNewBullets();
        nbmc = setInterval(makeNewBullets, 200);
      } else {
        clearInterval(nbmc);
      }
    }

    function makeNewBullets() {
      var bullet = new Bullet(whiteShip.x1 + whiteShip.width/2 - 3, whiteShip.y1-8, 4);
      animationBucket.push(bullet);
      playSound(bulletSound);
    }

    function fitCanvasToScreen() {
      var sW = window.innerWidth;
      var sH = window.innerHeight;

      if (sW > sH) {
        cnvs.height = sH;
        cnvs.width = 3/2 * sH;
      } else {
        cnvs.width = sW;
        cnvs.height = 2/3 * sW;
      }
      scaleFactor = cnvs.width/480;
      // scaleFactor = cnvs.height/320; // both have same value
      if (cnvs.width < 1000) {
        imageFolder = "assets/sd/";
      } else {
        imageFolder = "assets/hd/";
      }
    }

    function animateImageSource(imgObject, imgSource, imgName, extension, numberOfFrames, frameDelay) {
      let indexForImageAnimationFrame = 1;
      setInterval(function() {
        imgObject.src = imgSource + imgName + indexForImageAnimationFrame + extension;
        indexForImageAnimationFrame++;
        if (indexForImageAnimationFrame > numberOfFrames) {
          indexForImageAnimationFrame = 1;
        }
      },
        frameDelay)
    }
    function ImageObject(source) {
      let tempImage = new Image();
      tempImage.src = source;
      return tempImage;
    }

    function sendEnemies() {
      var ufo = new UFO(Math.floor(Math.random() * 8) * 60,
        -30,
        40);
      animationBucket.push(ufo);
    }

    function decideMovements(obj) {
      if (obj instanceof UFO) {
        obj.y1 += 3;
      } else if (obj instanceof Bullet) {
        obj.y1 -= 3;
      }
    }

    function move(num, isStarted) {
      var w = whiteShip;
      switch (num) {
        case 1:
          var op = 'y1-';
          break;
        case 2:
          var op = 'x1+';
          break;
        case 3:
          var op = 'y1+';
          break;
        case 4:
          var op = 'x1-';
          break;
      }
      if (!isStarted && w.x2 > 0 && w.x1 < 480 && w.y2 > 0 && w.y1 < 320) {
        var wsmc = setInterval(function() {
          if (w.x1 > 0 && w.x2 < 480 && w.y1 > 0 && w.y2 < 320) {
            eval('w.' + op + '= 2');
          }
        },
          20);
        intervalControls.push(wsmc);
      } else {
        intervalControls.forEach((item) => {
          clearInterval(item);
        }
        );
      }
    }

    function detectCollisions() {
      let h = whiteShip;
      let bullets = animationBucket.filter((i) =>  i instanceof Bullet);
      let ships = animationBucket.filter((i) =>  i instanceof UFO);

      bullets.forEach(function (b) {
        ships.forEach (function (s) {
          if (b.x1 <= s.x2 && b.x2 >= s.x1 && b.y1 <= s.y2 && b.y2 >= s.y1) {
            animationBucket = animationBucket.filter((i) =>  (i != b && i != s));
            //blast here
            score += 10;
            updateScore();
          }
        }
        );
    }
    );
    ships.forEach(function (s) {
      if (h.x1 <= s.x2 && h.x2 >= s.x1 && h.y1 <= s.y2 && h.y2 >= s.y1) {
        stopGame();
        console.log("Game Over!");
      }
    }
    );
  }
  function stopGame() {
    //  ---------
  }
  function createArrayBuffer(soundFile, soundVar) {
    var request = new XMLHttpRequest();
    request.open('GET',
      'assets/sounds/'+ soundFile,
      true);
    request.responseType = 'arraybuffer';
    request.send();
    request.onreadystatechange = function() {
      if (request.readyState == 4) {
        audioContext.decodeAudioData(request.response, function(buffer) {
          eval(soundVar + '=' + 'buffer');
        }
        );
      }
    }
  }
  function playSound(soundFile) {
    var source = audioContext.createBufferSource();
    source.buffer = soundFile;
    source.connect(audioContext.destination);
    source.start(0);
  }

  //Define Classes From Here!

  var scaleFactor = 1;
  class AllObjects {
    constructor(x1, y1, width) {
      this.x1 = x1;
      this.y1 = y1;
      this.width = width;
    }
    get x2() {
      return this.x1 + this.width;
    }
    get height() {
      return this.width * this.img.height/this.img.width;
    }
    get y2() {
      return this.y1 + this.height;
    }

    draw() {
      let s = scaleFactor;
      ctx.drawImage(this.img, this.x1 * s, this.y1 * s, this.width * s, this.height * s);
    }
  }

  class HeroShip extends AllObjects {
    constructor(x1, y1, width) {
      super(x1, y1, width);
    }
    get img() {
      return whiteShipImage;
    }
  }
  class Bullet extends AllObjects {
    constructor(x1, y1, width) {
      super(x1, y1, width);
    }
    get img() {
      return bulletImage;
    }
  }

  class UFO extends AllObjects {
    constructor(x1, y1, width) {
      super(x1, y1, width);
    }
    get img() {
      return ufoImage;
    }
  }

  var whiteShip = new HeroShip(200, 260, 40);
  animationBucket.push(whiteShip);

</script>
</body>
</html>